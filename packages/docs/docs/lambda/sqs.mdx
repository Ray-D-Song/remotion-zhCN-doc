---
image: /generated/articles-docs-lambda-sqs.png
title: ä½¿ç”¨ Lambda ä¸ SQS
slug: /lambda/sqs
sidebar_label: ä½¿ç”¨ SQS è¿›è¡Œæ’é˜Ÿ
crumb: '@remotion/lambda'
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

:::note
è¿™ä¸ªè¿‡ç¨‹å­˜åœ¨ä¸€ä¸ªç¼ºé™·ï¼šé˜Ÿåˆ—ä¼šåœ¨è§¦å‘æ¸²æŸ“æ—¶ç«‹å³ç»§ç»­ï¼Œè€Œä¸æ˜¯åœ¨æ¸²æŸ“å®Œæˆæ—¶ç»§ç»­ã€‚è¿™æ„å‘³ç€æ¸²æŸ“ä¸ä¼šæŒ‰é¡ºåºæ‰§è¡Œã€‚æˆ‘ä»¬æ­£åœ¨ç ”ç©¶æ”¹è¿›çš„ Lambda æ’é˜Ÿç­–ç•¥ç‰ˆæœ¬ï¼ŒåŒæ—¶è¯·æ³¨æ„è¿™ç§è¡Œä¸ºã€‚
:::

æœ¬æŒ‡å—å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ [Amazon SQS](https://aws.amazon.com/sqs/)ï¼ˆç®€å•é˜Ÿåˆ—æœåŠ¡ï¼‰å’Œ Remotion çš„ [`renderMediaOnLambda()`](/docs/lambda/rendermediaonlambda) APIã€‚

é˜Ÿåˆ—ç”¨äºæš‚åœè¯·æ±‚ï¼Œä»¥ä¾¿åº•å±‚èµ„æºèƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ã€‚ç”±äº AWS Lambda å—åˆ°[å¹¶å‘é™åˆ¶](/docs/lambda/troubleshooting/rate-limit)çš„å½±å“ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ SQS åœ¨åå°æ’é˜Ÿæ¸²æŸ“ï¼Œå¹¶é€šè¿‡å‘é€ç”µå­é‚®ä»¶æˆ–ä½¿ç”¨å…¶ä»–é€šçŸ¥æ–¹å¼é€šçŸ¥ç”¨æˆ·æ¸²æŸ“è¿‡ç¨‹ä½•æ—¶å®Œæˆã€‚

ä¸ºäº†è¡¥å……æœ¬æŒ‡å—ï¼Œå·²åˆ›å»ºäº†ä¸¤ä¸ªé¡¹ç›®ï¼š

- [remotion-app](https://github.com/alexfernandez803/remotion-serverless/tree/main/remotion-app) åŒ…å« Remotion ç»„åˆå’Œç”¨äºåœ¨ AWS ä¸­éƒ¨ç½²å’Œåˆ é™¤ Remotion Lambda åŸºç¡€è®¾æ–½çš„å®ç”¨è„šæœ¬ã€‚è¯·æ³¨æ„ï¼Œè¿™ä¸[Serverless Framework æŒ‡å—](/docs/lambda/serverless-framework-integration)ä¸­çš„åº”ç”¨ç¨‹åºç›¸åŒã€‚
- [apigw-sqs-app](https://github.com/alexfernandez803/remotion-serverless/tree/main/apigw-sqs-app)ï¼ˆAPI Gateway SQSï¼‰åŒ…å«ä¸€ä¸ª [CDK](https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html) é¡¹ç›®ï¼Œéƒ¨ç½²äº†ä¸¤ä¸ª Lambda å‡½æ•°ã€‚[enqueue-function](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/src/enqueue-function/index.ts) å‡½æ•°åœ¨è°ƒç”¨æ—¶å°†ç”¨æˆ·å‘é€çš„ JSON æ•°æ®æ’å…¥é˜Ÿåˆ—ï¼›è¿™å¯ä»¥æ˜¯ Remotion Lambda å‡½æ•°çš„è¾“å…¥æœ‰æ•ˆè´Ÿè½½ã€‚[render-lambda-function](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/src/render-lambda-function/index.ts) å‡½æ•°ç›‘å¬æ¥è‡ª SQS çš„æ’é˜Ÿæ¶ˆæ¯ï¼Œå¤„ç†å¹¶æ¸²æŸ“è§†é¢‘ã€‚

`enqueue-function`è¢«é…ç½®ä¸ºé€šè¿‡[API Gateway](https://aws.amazon.com/api-gateway/)è°ƒç”¨ï¼Œå¹¶ç”±[Cognito](https://aws.amazon.com/cognito/)è¿›è¡Œä¿æŠ¤ã€‚API Gatewayå’ŒCognitoçš„è®¾ç½®æ˜¯ç”±[CDK Stack](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts)åœ¨æ‰§è¡Œ`cdk deploy`æ—¶è‡ªåŠ¨åˆ›å»ºçš„ã€‚

æœ¬æŒ‡å—å‡å®šæ‚¨å…·æœ‰ä½¿ç”¨[CDKä¸TypeScript](https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html)å’Œ[AWS SQSçŸ¥è¯†](https://aws.amazon.com/sqs/)çš„çŸ¥è¯†ã€‚AWSäº‘å¼€å‘å·¥å…·åŒ…ï¼ˆCDKï¼‰å·²è¢«é€‰æ‹©ç”¨äºæä¾›åŸºç¡€è®¾æ–½ï¼Œå› ä¸ºå®ƒæ˜¯æ¥è‡ª[AWS](https://aws.amazon.com)çš„å®˜æ–¹åº“ã€‚

## remotion-app

- è¯·æŒ‰ç…§[remotion-appæŒ‡å—](/docs/lambda/serverless-framework-integration#remotion-app)ä¸­çš„ç›¸åŒè®¾ç½®è¯´æ˜è¿›è¡Œæ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬å°†é‡å¤ä½¿ç”¨è¯¥åº”ç”¨ç¨‹åºã€‚

## apigw-sqs-app

åœ¨ä»¥ä¸‹æ­¥éª¤ä¸­ï¼ŒLambdaå‡½æ•°[`enqueue-function`](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/src/enqueue-function/index.ts)å’Œ[`render-lambda-function`](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/src/render-lambda-function/index.ts)å°†éƒ¨ç½²åˆ°æ‚¨çš„AWSå¸æˆ·ã€‚æœ¬æŒ‡å—æ—¨åœ¨åœ¨æ‚¨çš„æœ¬åœ°è®¡ç®—æœºä¸Šæ‰§è¡Œã€‚

è¯¥é¡¹ç›®å°†åˆ›å»ºCDKå †æ ˆå®šä¹‰çš„æ‰€æœ‰èµ„æºï¼ŒåŒ…æ‹¬ä¸ºé¡¹ç›®çš„èº«ä»½éªŒè¯å’Œæˆæƒç³»ç»Ÿè®¾ç½®[Cognito](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts#L19)ï¼Œä¸Šä¼ Lambdaä»£ç ï¼Œç”Ÿæˆå¹¶å…³è”IAMè§’è‰²åˆ°æ‚¨çš„AWSå¸æˆ·ã€‚

### å…ˆå†³æ¡ä»¶

- åœ¨æ‚¨çš„æœ¬åœ°è®¡ç®—æœºä¸Šå…·æœ‰AWSéƒ¨ç½²é…ç½®æ–‡ä»¶ï¼Œä»¥é…ç½®AWSéƒ¨ç½²é…ç½®æ–‡ä»¶ã€‚
- åˆ›å»ºåä¸º`remotion-executionrole-policy`çš„AWSç­–ç•¥ï¼Œè¯¥ç­–ç•¥æ˜¯ä»æ­¤[æŒ‡å—](/docs/lambda/without-iam/#1-create-role-policy)åˆ›å»ºçš„ã€‚
- AWS CDKåº”åœ¨æ‚¨çš„æœ¬åœ°è®¡ç®—æœºä¸Šå…¨å±€å®‰è£…ã€‚å¦‚æœå°šæœªå®Œæˆï¼Œè¯·æŒ‰ç…§æ­¤å¤„çš„â€œå®‰è£…AWS CDKâ€éƒ¨åˆ†çš„è¯´æ˜è¿›è¡Œæ“ä½œã€‚

### è®¾ç½®

#### 1. å…‹éš†æˆ–ä¸‹è½½é¡¹ç›®

è¯¥é¡¹ç›®å¯ä»¥åœ¨ [`remotion-serverless é¡¹ç›®`](https://github.com/alexfernandez803/remotion-serverless) æ‰¾åˆ°ã€‚å¦‚æœåœ¨ä¸Šä¸€æ­¥æ²¡æœ‰å®Œæˆï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å…‹éš†é¡¹ç›®ï¼š

```bash
git clone https://github.com/alexfernandez803/remotion-serverless
```

#### 2. è¿›å…¥ `remotion-serverless` å¹¶åˆ‡æ¢åˆ° `apigw-sqs-app` ç›®å½•

```bash
cd remotion-serverless && cd apigw-sqs-app
```

#### 3. å®‰è£…ä¾èµ–é¡¹

<Tabs
defaultValue="npm"
values={[
{ label: 'npm', value: 'npm', },
{ label: 'yarn', value: 'yarn', },
{ label: 'pnpm', value: 'pnpm', },
]
}>
<TabItem value="npm">

```bash
npm i
```

</TabItem>

<TabItem value="pnpm">

```bash
pnpm i
```

</TabItem>

<TabItem value="yarn">

```bash
yarn
```

</TabItem>

</Tabs>

#### 4. åˆ›å»º Remotion ç­–ç•¥

- å¦‚æœå°šæœªåˆ›å»º `remotion-executionrole-policy`ï¼Œè¯·æŒ‰ç…§æ­¤ [æŒ‡å—](/docs/lambda/without-iam/#1-create-role-policy) è¿›è¡Œè®¾ç½®ã€‚

`remotion-executionrole-policy` æ˜¯ä» [è¿™é‡Œ](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts#L64) å¼•ç”¨çš„ã€‚`CDK` å †æ ˆä¸º `render-lambda-function` åˆ›å»ºäº†ä¸€ä¸ªåä¸º `remotion-executionrole-policy` çš„è§’è‰²ã€‚

```ts
// ğŸ‘‡ Create a role with custom name
const renderFunctionLambdaRole = new Role(this, 'remotionSQSLambdaRole', {
  roleName: 'remotionSQSLambdaRole',
  assumedBy: new ServicePrincipal('lambda.amazonaws.com'),
  managedPolicies: [
    ManagedPolicy.fromAwsManagedPolicyName(
      'service-role/AWSLambdaBasicExecutionRole',
    ),
    ManagedPolicy.fromManagedPolicyName(
      this,
      'remotion-executionrole-policy',
      'remotion-executionrole-policy',
    ),
  ],
});
```

è¿™å°†åœ¨ AWS ä¸­åˆ›å»ºä¸€ä¸ªåä¸º `remotionSQSLambdaRole` çš„è§’è‰²ï¼Œå¹¶é™„åŠ äº† 2 ä¸ªç­–ç•¥ï¼š

- `service-role/AWSLambdaBasicExecutionRole` æˆäºˆ Lambda å‡½æ•°ä¸ [CloudWatch](https://aws.amazon.com/cloudwatch/) äº¤äº’å’Œè®°å½•ä¿¡æ¯çš„æƒé™ã€‚æ­¤ç­–ç•¥æ˜¯ AWS ç­–ç•¥åº“çš„ä¸€éƒ¨åˆ†ã€‚
- `remotion-executionrole-policy` ç­–ç•¥æˆäºˆ Lambda å‡½æ•°ä¸ Remotion Lambda éœ€è¦è®¿é—®çš„ AWS æœåŠ¡è¿›è¡Œäº¤äº’ä»¥æ¸²æŸ“è§†é¢‘çš„æƒé™ã€‚æ­¤ç­–ç•¥ä¸æ­¤ [æŒ‡å—](/docs/lambda/without-iam/#1-create-role-policy) ä¸­çš„ç­–ç•¥å®Œå…¨ç›¸åŒã€‚

#### 5. å¯é€‰ - åˆæˆ

ä» `apigw-sqs-app` ç›®å½•ä¸­ï¼Œæ‰§è¡Œ `cdk synthesize` å‘½ä»¤ã€‚

```bash
cdk synthesize
```

è¿™ä¸ªå‘½ä»¤å°†å±•ç¤º CDK å°†è¦åœ¨æ‚¨çš„ AWS è´¦æˆ·ä¸­æ‰§è¡Œçš„ [CloudFormation æ¨¡æ¿](https://aws.amazon.com/cloudformation/)ã€‚

#### 6. éƒ¨ç½² apigw-sqs-app é¡¹ç›®

ä» `apigw-sqs-app` ç›®å½•ä¸­ï¼Œæ‰§è¡Œ `cdk deploy` å‘½ä»¤ã€‚

```bash
cdk deploy
```

è¿™å°†åè°ƒ CDK æ ˆä¸­å®šä¹‰çš„èµ„æºçš„ç”Ÿæˆï¼Œè¿™äº›èµ„æºæ˜¯åå°ä¸­çš„ CloudFormation æ¨¡æ¿ã€‚

```bash title="éƒ¨ç½²è¾“å‡º"
 Bundling asset apigw-sqs-app-stack/enqueue-function/Code/Stage...

  cdk.out/bundling-temp-a813aece2454684086de775f918faac45b1b77c67fff24ec6aad4bff8c978ebe/index.js  881.5kb

âš¡ Done in 72ms
Bundling asset apigw-sqs-app-stack/render-function/Code/Stage...

  cdk.out/bundling-temp-e7d973ee34691a8e6a2ceda969fbf59380866bb486be333238b7e554907f7b95/index.js  2.6kb

âš¡ Done in 2ms

added 279 packages, and audited 280 packages in 2s

21 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

âœ¨  Synthesis time: 7.97s

apigw-sqs-app-stack: building assets...

[0%] start: Building 8efaff13bbe794558db1f1cb8f506bc13b87d7ab3e568ebc324bac680da3a75d:XXXXXXXXXX-ap-southeast-2
[0%] start: Building 3b7a9f596977e2db94a676c6c89c99dd7eb87a5985f97a11ff23b9f338027764:XXXXXXXXXX-ap-southeast-2
[0%] start: Building cf7f13fe5c0ff3b22e7352152a554dd8a4767f6a5e2285e6bf353fc42070e697:XXXXXXXXXX-ap-southeast-2
[33%] success: Built 8efaff13bbe794558db1f1cb8f506bc13b87d7ab3e568ebc324bac680da3a75d:XXXXXXXXXX-ap-southeast-2
[66%] success: Built 3b7a9f596977e2db94a676c6c89c99dd7eb87a5985f97a11ff23b9f338027764:XXXXXXXXXX-ap-southeast-2
[100%] success: Built cf7f13fe5c0ff3b22e7352152a554dd8a4767f6a5e2285e6bf353fc42070e697:XXXXXXXXXX-ap-southeast-2

apigw-sqs-app-stack: assets built

This deployment will make potentially sensitive changes according to your current security approval level (--require-approval broadening).
Please confirm you intend to make the following modifications:

IAM Statement Changes
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚ Resource                    â”‚ Effect â”‚ Action                      â”‚ Principal                   â”‚ Condition                      â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${api-integration-role.Arn} â”‚ Allow  â”‚ sts:AssumeRole              â”‚ Service:lambda.amazonaws.co â”‚                                â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚ m                           â”‚                                â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${enqueue-function.Arn}     â”‚ Allow  â”‚ lambda:InvokeFunction       â”‚ Service:apigateway.amazonaw â”‚ "ArnLike": {                   â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚ s.com                       â”‚   "AWS:SourceArn": "arn:${AWS: â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ :Partition}:execute-api:ap-sou â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ theast-2:XXXXXXXXXX:${apiC85 â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ 50315}/*/*/enqueue"            â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ }                              â”‚
â”‚ + â”‚ ${enqueue-function.Arn}     â”‚ Allow  â”‚ lambda:InvokeFunction       â”‚ Service:apigateway.amazonaw â”‚ "ArnLike": {                   â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚ s.com                       â”‚   "AWS:SourceArn": "arn:${AWS: â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ :Partition}:execute-api:ap-sou â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ theast-2:XXXXXXXXXX:${apiC85 â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ 50315}/*/*/enqueue"            â”‚
â”‚   â”‚                             â”‚        â”‚                             â”‚                             â”‚ }                              â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${queue.Arn}                â”‚ Allow  â”‚ sqs:ChangeMessageVisibility â”‚ AWS:${remotionSQSLambdaRole â”‚                                â”‚
â”‚   â”‚                             â”‚        â”‚ sqs:DeleteMessage           â”‚ }                           â”‚                                â”‚
â”‚   â”‚                             â”‚        â”‚ sqs:GetQueueAttributes      â”‚                             â”‚                                â”‚
â”‚   â”‚                             â”‚        â”‚ sqs:GetQueueUrl             â”‚                             â”‚                                â”‚
â”‚   â”‚                             â”‚        â”‚ sqs:ReceiveMessage          â”‚                             â”‚                                â”‚
â”‚ + â”‚ ${queue.Arn}                â”‚ Allow  â”‚ sqs:GetQueueAttributes      â”‚ AWS:${api-integration-role} â”‚                                â”‚
â”‚   â”‚                             â”‚        â”‚ sqs:GetQueueUrl             â”‚                             â”‚                                â”‚
â”‚   â”‚                             â”‚        â”‚ sqs:SendMessage             â”‚                             â”‚                                â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${remotionSQSLambdaRole.Arn â”‚ Allow  â”‚ sts:AssumeRole              â”‚ Service:lambda.amazonaws.co â”‚                                â”‚
â”‚   â”‚ }                           â”‚        â”‚                             â”‚ m                           â”‚                                â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
IAM Policy Changes
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚ Resource                 â”‚ Managed Policy ARN                                                             â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${api-integration-role}  â”‚ arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${remotionSQSLambdaRole} â”‚ arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole â”‚
â”‚ + â”‚ ${remotionSQSLambdaRole} â”‚ arn:${AWS::Partition}:iam::XXXXXXXXXX:policy/remotion-executionrole-policy   â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

Do you wish to deploy these changes (y/n)? y

```

é€‰æ‹© 'y' ä½œä¸ºæç¤ºçš„ç­”æ¡ˆï¼ŒCDK å°†ç»§ç»­éƒ¨ç½² Stackï¼Œå…¶ä¸­åŒ…æ‹¬ 2 ä¸ªå‡½æ•°ã€‚

```bash title="æœ€ç»ˆè¾“å‡º"
apigw-sqs-app-stack: deploying... [1/1]
[0%] start: Publishing 8efaff13bbe794558db1f1cb8f506bc13b87d7ab3e568ebc324bac680da3a75d:XXXXXXXXXX-ap-southeast-2
[0%] start: Publishing 3b7a9f596977e2db94a676c6c89c99dd7eb87a5985f97a11ff23b9f338027764:XXXXXXXXXX-ap-southeast-2
[0%] start: Publishing cf7f13fe5c0ff3b22e7352152a554dd8a4767f6a5e2285e6bf353fc42070e697:XXXXXXXXXX-ap-southeast-2
[33%] success: Published 3b7a9f596977e2db94a676c6c89c99dd7eb87a5985f97a11ff23b9f338027764:XXXXXXXXXX-ap-southeast-2
[66%] success: Published 8efaff13bbe794558db1f1cb8f506bc13b87d7ab3e568ebc324bac680da3a75d:XXXXXXXXXX-ap-southeast-2
[100%] success: Published cf7f13fe5c0ff3b22e7352152a554dd8a4767f6a5e2285e6bf353fc42070e697:XXXXXXXXXX-ap-southeast-2
apigw-sqs-app-stack: creating CloudFormation changeset...

 âœ…  apigw-sqs-app-stack

âœ¨  Deployment time: 158.36s

Outputs:
apigw-sqs-app-stack.apiUrl = https://6mvgq2iad9.execute-api.ap-southeast-2.amazonaws.com/
apigw-sqs-app-stack.queuearn = arn:aws:sqs:ap-southeast-2:XXXXXXXXXX:remotion_queue
apigw-sqs-app-stack.queuename = remotion_queue
apigw-sqs-app-stack.queueurl = https://sqs.ap-southeast-2.amazonaws.com/XXXXXXXXXX/remotion_queue
apigw-sqs-app-stack.region = ap-southeast-2
apigw-sqs-app-stack.userPoolClientId = 5d88adjpffj314pm4pot8g292i
apigw-sqs-app-stack.userPoolId = ap-southeast-2_vzSlhO9O0
Stack ARN:
arn:aws:cloudformation:ap-southeast-2:XXXXXXXXXX:stack/apigw-sqs-app-stack/acb8b8f0-a52a-11ed-a440-024da00b5a8e

```

éƒ¨ç½²å°†æä¾›å˜é‡ï¼Œå¦‚ `apigw-sqs-app-stack.region`ã€`apigw-sqs-app-stack.userPoolClientId` å’Œ `apigw-sqs-app-stack.userPoolId`ã€‚

#### 8. å¦‚æœä¸å†éœ€è¦ï¼Œä»æ‚¨çš„ AWS è´¦æˆ·ä¸­ç§»é™¤ apigw-sqs-app

ä» `apigw-sqs-app` ç›®å½•ä¸­ã€‚

```bash
cdk destroy
```

### å°† API Gatewayã€Remotion Lambda å’Œ SQS ç»“åˆåœ¨ä¸€èµ·ã€‚

è¿™äº›æ˜¯æœ‰å…³ IAM è§’è‰²å¦‚ä½•è¢«å‡½æ•°ä½¿ç”¨ä»¥åŠå¦‚ä½•å¯ç”¨ [render-lambda-function](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts#L97) æ¥æ¶ˆè€— SQS æ¶ˆæ¯çš„é‡è¦ä¿¡æ¯ã€‚

ä» [CDK æ ˆä»£ç ](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts#L64) ä¸­ï¼Œä»¥ä¸‹æ˜¯éœ€è¦æ³¨æ„çš„é‡è¦éƒ¨åˆ†ã€‚

- è¯¥æ ˆåˆ›å»ºäº†ä¸€ä¸ªåä¸º `remotion_queue` çš„é˜Ÿåˆ—ã€‚

```js title="åˆ›å»ºé˜Ÿåˆ—"
// ğŸ‘‡ create the queue
const remotionQueue = new sqs.Queue(this, 'queue', {
  encryption: sqs.QueueEncryption.KMS_MANAGED,
  queueName: 'remotion_queue',
});
```

- `remotion_queue` æˆäºˆ 2 ä¸ª Lambda å‡½æ•°ä¸å…¶äº¤äº’çš„è®¿é—®æƒé™ã€‚æ¯ä¸ªå•ç‹¬çš„è§’è‰²åˆ†é…ç»™å…¶å„è‡ªçš„ Lambda å‡½æ•°ã€‚

  ```js title="apiIntegrationRole"
  // ğŸ‘‡ create the apiIntegrationRole role
  const apiIntegrationRole = new IAM.Role(this, 'api-integration-role', {
    assumedBy: new IAM.ServicePrincipal('lambda.amazonaws.com'),
    managedPolicies: [
      ManagedPolicy.fromAwsManagedPolicyName(
        'service-role/AWSLambdaBasicExecutionRole',
      ),
    ],
  });
  ```

- æ­¤è§’è‰²åˆ†é…ç»™ [`enqueue-function`](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts#L86)ï¼Œä»¥å…è®¸å…¶å†™å…¥ CloudWatch æ—¥å¿—ã€‚

  ```js title="remotionSQSLambdaRole"
  // ğŸ‘‡ create a role with custom name
  const renderFunctionLambdaRole = new Role(this, 'remotionSQSLambdaRole', {
    roleName: 'remotionSQSLambdaRole',
    assumedBy: new ServicePrincipal('lambda.amazonaws.com'),
    managedPolicies: [
      ManagedPolicy.fromAwsManagedPolicyName(
        'service-role/AWSLambdaBasicExecutionRole',
      ),
      ManagedPolicy.fromManagedPolicyName(
        this,
        'remotion-executionrole-policy',
        'remotion-executionrole-policy',
      ),
    ],
  });
  ```

- [`render-lambda-function`](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts#L97) å·²è¢«åˆ†é…æ­¤è§’è‰²ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸ Cloudwatch äº¤äº’çš„è®¿é—®æƒé™ä»¥åŠæ ¹æ® `remotion-executionrole-policy` ä¸­æŒ‡å®šçš„å…¶ä»– AWS æœåŠ¡çš„è®¿é—®æƒé™ã€‚

  ```js title="æˆäºˆé˜Ÿåˆ—è®¿é—®æƒé™"
  // ğŸ‘‡ Grant permission to publish to the queue
  remotionQueue.grantSendMessages(apiIntegrationRole);
  // ğŸ‘‡ grant permission to consume messages from the queue
  remotionQueue.grantConsumeMessages(renderFunctionLambdaRole);
  ```

- å…è®¸æ¸²æŸ“å‡½æ•°ç›‘å¬é˜Ÿåˆ—ã€‚

  ```js title="ç›‘å¬é˜Ÿåˆ—"
  remotionRenderFunction.addEventSource(
    new SqsEventSource(remotionQueue, {
      batchSize: 1,
      maxBatchingWindow: Duration.minutes(5),
      reportBatchItemFailures: true, // default to false
    }),
  );
  ```

### ä¸ API äº¤äº’

API éœ€è¦æˆæƒä»¤ç‰Œæ‰èƒ½ä¸å…¶äº¤äº’ã€‚è¦è·å–ä»¤ç‰Œï¼š

- éƒ¨ç½²æˆåŠŸåï¼Œæ‚¨å°†è·å¾—è¾“å‡ºï¼Œä¾‹å¦‚ `apigw-sqs-app-stack.region`ã€`apigw-sqs-app-stack.userPoolClientId` å’Œ `apigw-sqs-app-stack.userPoolId`ï¼Œç”¨äºä¸ Cognito è¿›è¡Œèº«ä»½éªŒè¯ã€‚
- å¦‚æœæ‚¨æ²¡æœ‰éœ€è¦ç”¨æˆ·ç™»å½•çš„å‰ç«¯ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§æ­¤ [æŒ‡å—](/docs/lambda/without-iam/example#test-your-endpoint) ä¸º API åˆ›å»ºç”¨æˆ·å’Œèº«ä»½éªŒè¯ä»¤ç‰Œã€‚

ä»æŒ‡å—ä¸­ï¼Œ`YOUR_USER_POOL_CLIENT_ID` æ˜¯ `apigw-sqs-app-stack.userPoolClientId`ï¼Œ`YOUR_USER_POOL_ID` æ˜¯ `apigw-sqs-app-stack.userPoolId`ï¼Œåº”æŒ‰ç…§æ­¥éª¤è¿›è¡Œï¼Œç›´åˆ°æ£€ç´¢åˆ° `IdToken`ã€‚

åŸºæœ¬ API URL çš„æ ¼å¼ä¸º `https://25w651t09g.execute-api.ap-southeast-2.amazonaws.com/dev/enqueue`ï¼Œæ¥è‡ªè¾“å‡º `apigw-sqs-app-stack.apiUrl`ã€‚

#### è§¦å‘è§†é¢‘ç”Ÿæˆè¯·æ±‚

```bash title="æ¸²æŸ“è§†é¢‘"
curl --location --request POST 'https://xxxxxxxx.execute-api.ap-southeast-2.amazonaws.com/dev/enqueue' \
--header 'Authorization: Bearer eyJraWQiOiJMVVVVZGtIQ1JXWEEyWEEXXXXXXXXXjMKR1t5S-oA' \
--data-raw '{
    "message": "Hello"
}'
```

```bash title="å“åº”"
{
   {"message":"æ¶ˆæ¯å·²å‘é€åˆ° SQS- è¿™æ˜¯ MessageId: a6abd0bc-b838-48b5-a562-4c511fac5b2f"}
}
```

è¿™å°†é€šè¿‡å°† JSON æ”¾å…¥é˜Ÿåˆ—æ¥å¯åŠ¨è§†é¢‘çš„æ¸²æŸ“è¯·æ±‚ã€‚  
åœ¨å¦ä¸€ç«¯ï¼Œ[`render-lambda-function`](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/src/render-lambda-function/index.ts) å°†é€šè¿‡ SQS è¢«é€šçŸ¥æœ‰ä¸€ä¸ªè§†é¢‘æ¸²æŸ“è¯·æ±‚ï¼Œå®ƒå°†ä»æ¸²æŸ“è¯·æ±‚ä¸­æ¶ˆè€—æ•°æ®å¹¶æ ¹æ®æŒ‡ç¤ºç”Ÿæˆè§†é¢‘ï¼Œè¯¥å‡½æ•°æ‰§è¡Œ [`renderMediaOnLambda()`](/docs/lambda/rendermediaonlambda) ä½œä¸ºæµç¨‹çš„ä¸€éƒ¨åˆ†ã€‚ 



## æ³¨æ„

- Remotion Lambda çš„éƒ¨ç½²é…ç½®ä¸ºä»…éƒ¨ç½²åˆ° `ap-southeast-2` åœ°åŒºï¼Œä»¥ç®€åŒ–é¡¹ç›®ï¼Œæ‚¨å¯ä»¥åœ¨ [`region.ts`](https://github.com/alexfernandez803/remotion-serverless/blob/main/remotion-app/src/infra/regions.ts) ä¸­çš„ä»£ç ä¸­è¿›è¡Œè°ƒæ•´ã€‚
- `apigw-sqs-app` çš„éƒ¨ç½²é…ç½®ä¸ºéƒ¨ç½²åˆ° `ap-southeast-2` åœ°åŒºï¼Œä»¥ç®€åŒ–é¡¹ç›®ï¼Œæ‚¨å¯ä»¥åœ¨ [`remotion-cdk-starter.ts`](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/bin/remotion-cdk-starter.ts) ä¸­çš„ä»£ç ä¸­è¿›è¡Œè°ƒæ•´ã€‚
- åœ¨éƒ¨ç½²æ—¶ï¼ŒRemotion åŒ…åº”è¯¥è¢«æ†ç»‘åœ¨å‡½æ•°å†…éƒ¨ï¼Œæ‚¨å¯ä»¥åœ¨ `bundling` å¯¹è±¡çš„ `nodeModules` å±æ€§ä¸­æ‰¾åˆ°æ­¤ä»£ç ï¼Œä»£ç ä½äº[è¿™é‡Œ](https://github.com/alexfernandez803/remotion-serverless/blob/main/apigw-sqs-app/lib/remotion-cdk-starter-stack.ts#L103)ã€‚

## å‚è§

- [åœ¨æ²¡æœ‰ IAM ç”¨æˆ·çš„æƒ…å†µä¸‹ä½¿ç”¨ Lambda](/docs/lambda/without-iam)
- [ä½¿ç”¨ Serverless Framework ä¸ Remotion Lambda](/docs/lambda/serverless-framework-integration)
