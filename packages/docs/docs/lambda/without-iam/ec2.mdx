---
image: /generated/articles-docs-lambda-without-iam-ec2.png
title: 使用 EC2 对 Lambda 进行身份验证
slug: /lambda/ec2
sidebar_label: 使用 EC2 + STS
crumb: "@remotion/lambda"
---

EC2 实例具有可以与 AWS SDK 交互的凭据。如果您想要将其与 Remotion Lambda 一起使用，您需要使用 STS 假定角色，以生成一个访问令牌，该访问令牌可以被 Remotion 使用。

本指南将演示如何从 AWS EC2 实例使用 [Node.js](https://nodejs.org/) 和 [TypeScript](https://www.typescriptlang.org/) 安全地与 Remotion 的 [`renderMediaOnLambda()`](/docs/lambda/rendermediaonlambda) 操作进行交互。

为了补充本指南，已创建了两个项目：

- [remotion-app](https://github.com/alexfernandez803/remotion-serverless/tree/main/remotion-app) 包括一个 Remotion 组合和用于在 AWS 中部署和删除 Remotion Lambda 基础设施的实用脚本。值得注意的是，这与 [Serverless Framework 指南](/docs/lambda/serverless-framework-integration) 中展示的应用程序相同。如果 Remotion Lambda 尚未部署到您的 AWS 帐户，请按照设置 [指南](/docs/lambda/serverless-framework-integration#remotion-app) 进行操作。

- [ec2-remotion-lambda](https://github.com/alexfernandez803/remotion-serverless/tree/main/ec2-remotion-lambda) 是一个 TypeScript Node.js 应用程序，通过 [REST](https://en.wikipedia.org/wiki/Representational_state_transfer) 端点启动视频渲染过程。

## 先决条件

- 在本地机器上具有 AWS 部署配置文件，以在本地机器上配置 AWS 部署配置文件。
- 创建名为 `remotion-executionrole-policy` 的 AWS 策略，该策略是从此 [指南](/docs/lambda/without-iam/#1-create-role-policy) 创建的。
- 了解 AWS 中 [IAM](https://docs.aws.amazon.com/iam/index.html) 和 [假定角色](https://docs.aws.amazon.com/IAM/latest/UserGuide/example_sts_AssumeRole_section.html) 的工作原理。
- 了解如何在 [EC2](https://aws.amazon.com/ec2/) 实例上创建和配置软件包，并在 [Ubuntu 发行版](https://ubuntu.com/) 上安装软件包。这包括 [Git](https://git-scm.com/)、[Node.js](https://nodejs.org/en)，以及运行 Node.js 应用程序。

## 设置 `ec2-remotion-lambda` 应用程序

### 1. 创建 Remotion 策略

- 如果尚未创建 `remotion-executionrole-policy`，请按照此[指南](/docs/lambda/without-iam/#1-create-role-policy)进行设置。

### 2. 为 Remotion 渲染执行创建角色

##### 步骤

1.转到您的 AWS 帐户的 IAM 角色部分。<br/>
2.点击“创建角色”。<br/>
3.在“选择受信任实体类型”下，选择“AWS 服务”，在“将使用此角色的服务”下，选择“Lambda”。点击“下一步：权限”。<br/>
4.在“附加权限策略”下，搜索“remotion-executionrole-policy”，并点击复选框以分配此策略。如果尚未创建该策略，请参考步骤 1。<br/>
5.此外，在“附加权限策略”中，清除筛选器并搜索“AWSLambdaBasicExecutionRole”。点击复选框，然后点击“下一步：标记”。<br/>
6.在“添加标记”页面上，您可以选择向角色添加标记。点击“下一步：审核”。<br/>
7.在“审核”页面上，将角色命名为“remotion-ec2-executionrole”。其余字段保持不变。<br/>
8.点击“创建角色”以确认。<br/>

### 3. 为 EC2 实例创建角色

#### 步骤

1.从您的 AWS 帐户的 IAM 角色部分开始。<br/>
2.点击“创建角色”。<br/>
3.在“选择受信任实体类型”下，选择“AWS 服务”，在“将使用此角色的服务”下，选择“EC2”。点击“下一步：权限”。<br/>
4.在“附加权限策略”下，暂时保持为空。点击“下一步：标记”。<br/>
5.在“添加标记”页面上，您可以选择向角色添加标记。点击“下一步：审核”。<br/>
6.在“审核”页面上，将角色命名为“ec2-remotion-role”。其余字段保持不变。<br/>
7.点击“创建角色”以确认。<br/>
8.记下角色的“ARN”。格式应为“arn:aws:iam::XXXXXXXX:role/ec2-remotion-role”<br/>



### 4. 信任"remotion-ec2-executionrole"的EC2角色

#### 步骤

1.从IAM角色部分，找到在步骤2中创建的角色，或者使用"remotion-ec2-executionrole"过滤角色名称。<br/>
2.单击角色以打开其详细信息页面。<br/>
3.从"信任关系"选项卡中，单击"编辑信任关系"按钮。<br/>
4.编辑策略声明以添加在步骤3中创建的EC2角色（ec2-remotion-role）的ARN。将其添加为一个主体和作为AWS主体。<br/>
5.保存对信任策略的更改。<br/><br/>

```json title="remotion-ec2-executionrole"
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    },
    {
      "Sid": "",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::XXXXXXXX:role/ec2-remotion-role"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

:::info
此配置授予`ec2-remotion-role`权限承担`remotion-ec2-executionrole`的角色，并提供访问AWS服务和资源所需的权限，以供Remotion进行视频渲染。
:::

### 6. 创建EC2实例

#### 步骤

- 从AWS管理控制台：<br/>
  1.通过从服务列表中选择EC2进入EC2仪表板。<br/>
  2.单击"启动实例"按钮。<br/>
  3.选择要用于实例的Amazon机器映像（AMI）。您可以从各种预配置的AMI中进行选择，或者您可以创建自己的AMI。对于此实例，请选择"Ubuntu AMI"。<br/>
  4.选择要用于实例的实例类型。实例类型确定实例将具有的CPU、内存、存储和网络容量。推荐的操作系统是Ubuntu，至少1Gib的RAM。<br/>
  5.配置实例详细信息，例如您要启动的实例数量、要使用的VPC和子网，以及您要启用的任何高级设置。<br/>
  6.从"网络设置"中勾选"允许SSH流量"，并从允许访问选择中选择"我的IP地址"。这将允许您通过SSH连接到服务器实例并通过SFTP上传应用程序代码。<br/>
  7.同样从"网络设置"中，单击"允许来自互联网的HTTP流量"，这将允许应用程序触发REST API操作。<br/>
  8.通过选择要使用的存储类型和大小为您的实例添加存储。<br/>
  9.从"高级详细信息"中，在"IAM实例配置文件"中找到您专门为EC2创建的角色，即"ec2-remotion-role"。<br/>
  10.查看您的实例启动详细信息，然后单击"启动"按钮。<br/>
  11.选择现有的密钥对或创建新的密钥对以安全连接到您的实例。此密钥对是访问您的实例通过SSH所必需的。<br/>
  12.通过单击"启动实例"按钮启动您的实例。<br/>
  13.等待您的实例启动。一旦准备就绪，您可以使用SSH、RDP或其他远程访问方法连接到它。<br/>



### 7. 将代码上传到服务器并安装依赖项 

应用程序在服务器上需要 [Node.js](https://nodejs.org/en) 和 [NVM](https://github.com/nvm-sh/nvm)。您可以按照此指南安装 Node.js。推荐的 Node.js 版本是 v18.15.0，NVM 在切换 Node.js 版本方面非常有帮助。安装并学习如何使用它，请参考此 [指南](https://blog.logrocket.com/how-switch-node-js-versions-nvm/)。

通过您熟悉的任何方式将应用程序 [代码](https://github.com/alexfernandez803/remotion-serverless/tree/main/ec2-remotion-lambda) 上传到 EC2 实例。对于此实例，代码是使用名为 [Cyberduck](https://cyberduck.io/) 的 SFTP 客户端上传的。将应用程序代码上传到主目录。从 Cyberduck 登录时，默认目录是 `/home/ubuntu.`

#### 安装依赖项

1. 使用 ssh 客户端连接到服务器，以下是连接到服务器的示例。<br/>

```
 ssh -i "remotion.pem" ubuntu@example.com
```

2. 进入应用程序目录<br/>

```bash
cd ec2-remotion-lambda
```

3. 执行以下命令以安装应用程序依赖项。<br/>

```bash
npm i
```

### 8. 配置应用程序环境变量

#### 步骤

1. 从应用程序目录中创建名为 <code>.env</code> 的文件<br/>
2. 为环境键分配值，例如 <code>PORT</code>、<code>REMOTION_ROLE_ARN</code>、<code>REMOTION_ROLE_SESSION_NAME</code>、<code>API_USERNAME</code>、<code>API_PASSWORD</code><br/><br/>

```bash title=".env"
PORT=8080
REMOTION_ROLE_ARN=arn:aws:iam::XXXXXXXXXX:role/remotion-ec2-executionrole
REMOTION_ROLE_SESSION_NAME=render-sessions
API_USERNAME=admin
API_PASSWORD=password
```

- `PORT` 代表应用程序可以运行的端口。
- `REMOTION_ROLE_ARN` 代表应用程序“假定”以渲染视频的角色的 `ARN`，对于此实例，它是从 `步骤 2` 中的 `remotion-ec2-executionrole` ARN。
- `REMOTION_ROLE_SESSION_NAME` 是一个用于唯一标识角色会话的名称，当相同角色被不同主体假定时。

应用程序使用`基本身份验证`或用户名和密码进行安全保护，在生产环境中，这需要更新为更强大的安全机制。

- `API_USERNAME`代表与API交互时要使用的用户名。
- `API_PASSWORD`代表与API交互时要使用的密码。

### 9. 从应用程序目录运行应用程序，执行以下命令

```bash
npm run start
```

该应用程序将启动一个 HTTP 服务，可通过`.env`中指定的端口访问，本示例中端口为 8080。

### 9. 与 API 交互

可以使用 CURL 与应用程序进行交互。要与 API 交互，请按照以下步骤操作。

- 由于应用程序仍然不是一个守护进程，请启动另一个 shell 会话以连接到服务器。

  ```bash
  ssh -i "remotion.pem" ubuntu@example.com
  ```

- 执行 CURL 命令

  ```bash title=请求
   curl --location --request POST 'http://localhost:8080/render' \
  --header 'Authorization: Basic YWRtaW46cGFzc3dvcmQ='
  ```

  `Authorization` 头部是单词 `Basic` 和一个空格的组合，然后是由冒号连接在一起的 `base64` 编码的用户名和密码。

  从 `/render` API 资源开始，应用程序将执行这段 [代码](https://github.com/alexfernandez803/remotion-serverless/blob/main/ec2-remotion-lambda/src/services/render-services.ts#L11)。这些代码假定了 `ec2-remotion-role` 的角色，然后提供了临时访问令牌，即 `AccessKeyId`、`SecretAccessKey` 和 `SessionToken`。然后需要将这些凭据设置为服务器上的环境变量，以便它们可以被 [`renderMediaOnLambda()`](/docs/lambda/rendermediaonlambda) 进程使用。设置环境参数将路由渲染过程到这个 [代码](https://github.com/alexfernandez803/remotion-serverless/blob/main/ec2-app/render_handler.ts#L14)。

  ```bash title="API 响应"
  {"message":"视频已渲染。","renderId":"px60ct13fy","bucketName":"remotionlambda-apsoutheast2-qv16gcf02l"}
  ```

### 10. 清理：从您的AWS账户中销毁EC2实例

#### 步骤

1.从您的AWS账户中。<br/>
2.从可用服务列表中点击“EC2”服务。<br/>
3.在EC2仪表板中，选择要销毁的实例。对于此实例，它是“remotion-server”。<br/>
4.确保您已选择了正确的实例，然后点击页面顶部的“操作”按钮。<br/>
5.在“操作”下拉菜单中，选择“实例状态”，然后从子菜单中点击“终止”。<br/>
6.会出现一个警告消息，询问您确认终止操作。点击“是，终止”按钮继续。<br/>
7.确认终止后，实例将进入“正在关闭”状态，可能需要几分钟才能完全终止实例。<br/>
8.实例终止后，您将无法再访问它或存储在其中的任何数据。<br/><br/>

:::note
这是使用Remotion的Lambda和EC2的简单演示。要将此方法投入生产，可能需要根据用例采取其他步骤。实施企业级安全机制，将应用程序作为服务运行，并使其位于类似[Nginx](https://www.nginx.com/)的反向代理后面。
:::

## 另请参阅

- [权限](/docs/lambda/permissions)
- [无IAM用户使用Lambda](/docs/lambda/without-iam)
- [使用Serverless Framework与Remotion Lambda](/docs/lambda/serverless-framework-integration)
- [使用Lambda与SQS](/docs/lambda/sqs)
