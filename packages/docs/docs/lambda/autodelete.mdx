---
image: /generated/articles-docs-lambda-autodelete.png
title: 自动删除渲染
id: autodelete
slug: /lambda/autodelete
crumb: "Lambda API"
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

_从 v4.0.32 开始可用_

要在一段时间后自动删除渲染和相关文件，您需要：

<Step>1</Step> 启用 AWS 存储桶上的生命周期规则。<br/>
<Step>2</Step> 使用 <code>deleteAfter</code> 选项渲染视频。

## 应用生命周期规则

<Step>1</Step> <strong>确保具有正确的权限</strong>

要在存储桶上设置生命周期规则，您需要为您的用户具有 `s3:PutLifecycleConfiguration` 权限。

- 如果您在 4.0.32 之后设置了 Remotion Lambda，则会自动具有此权限。
- 如果您之前设置了 Remotion Lambda，请执行以下操作：
  1. 升级至至少 Remotion 4.0.32。
  2. [点击这里](https://us-east-1.console.aws.amazon.com/iamv2/home) 转到 AWS 控制台中的用户部分。
  3. 选择您的用户。
  4. 在“权限策略”下，单击您的策略（蓝色下划线）
  5. 选择“JSON”模式进行编辑。
  6. 在 `"Sid": "Storage"` 部分下，将 `"s3:PutLifecycleConfiguration"` 添加到 `"Action"` 数组中。
  7. 保存。

<br/>
<Step>2</Step> <strong>启用生命周期规则</strong>

使用 `--enable-folder-expiry` 选项重新部署站点。此操作将修改 S3 存储桶以应用 [AWS 生命周期规则](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html)。

<Tabs
defaultValue="cli"
values={[
{ label: 'CLI', value: 'cli', },
{ label: 'Node.JS', value: 'bucket', },
]
}>
<TabItem value="cli">

```bash title="在命令行中"
npx remotion lambda sites create --site-name=my-site-name --enable-folder-expiry
```

  </TabItem>

  <TabItem value="bucket">

```ts twoslash title="deploy.mjs" {6}
// @module: esnext
// @target: es2017
import { deploySite, getOrCreateBucket } from "@remotion/lambda";
import path from "path";

const { bucketName } = await getOrCreateBucket({
  region: "us-east-1",
  enableFolderExpiry: true,
});

const { serveUrl } = await deploySite({
  entryPoint: path.resolve(process.cwd(), "src/index.ts"),
  bucketName, // use the bucket with lifecyle rules
  region: "us-east-1",
});
console.log(serveUrl);
```

  </TabItem>

</Tabs>

<details>
<summary>
验证是否成功
</summary>
<p>在您的 S3 存储桶中，在“管理”下，您应该看到 4 个生命周期规则。</p>
<img src="/img/lambda/applied-lc-rules.png" />
</details>


<br/>

## 触发带有过期时间的渲染

有效值为 `"1-day"`, `"3-days"`, `"7-days"` 和 `"30-days"`。

<Tabs
defaultValue="cli"
values={[
{ label: 'CLI', value: 'cli', },
{ label: 'renderMediaOnLambda()', value: 'rendermedia', },
{ label: 'renderStillOnLambda()', value: 'renderstill', },
]
}>
<TabItem value="cli">

```bash
npx remotion lambda render testbed-v6 react-svg --delete-after="1-day"
```

  </TabItem>

  <TabItem value="rendermedia">

```tsx twoslash title="render.ts" {10}
// @module: esnext
// @target: es2017
// ---cut---
import { renderMediaOnLambda } from "@remotion/lambda/client";

const { bucketName, renderId } = await renderMediaOnLambda({
  region: "us-east-1",
  functionName: "remotion-render-bds9aab",
  composition: "MyVideo",
  serveUrl:
    "https://remotionlambda-qg35eyp1s1.s3.eu-central-1.amazonaws.com/sites/bf2jrbfkw",
  codec: "h264",
  deleteAfter: "1-day",
});
```

  </TabItem>
  <TabItem value="renderstill">

```tsx twoslash title="render.ts" {12}
// @module: esnext
// @target: es2017
// ---cut---
import { renderStillOnLambda } from "@remotion/lambda/client";

const { bucketName, renderId } = await renderStillOnLambda({
  region: "us-east-1",
  functionName: "remotion-render-bds9aab",
  composition: "MyVideo",
  serveUrl:
    "https://remotionlambda-qg35eyp1s1.s3.eu-central-1.amazonaws.com/sites/bf2jrbfkw",
  inputProps: {},
  privacy: "public",
  imageFormat: "png",
  deleteAfter: "1-day",
});
```

  </TabItem>
</Tabs>

<details>
<summary>
验证是否成功

</summary>

<p>
查看对象属性时，所有文件应具有过期规则和过期日期设置。
</p>

<img src="/img/lambda/rendered-file-path.png" />
<img src="/img/lambda/rendered-file-management.png" />

<br/>
<br/>

AWS 不会在确切的时间删除文件，但删除将会发生。

</details>

## 工作原理

通过应用 AWS 生命周期规则，我们指示 AWS S3 根据其前缀删除文件。当 `deleteAfter` 定义为 `"1-day"` 时，`renderId` 将以 `1-day` 为前缀，并且 S3 键将以 `renders/1-day-*` 开头，将应用删除规则。  
删除的基础是文件/文件夹的 `最后修改日期`。

<table>
  <tr>
    <th>
      <code>deleteAfter</code> 值
    </th>
    <th>
      渲染前缀
    </th>
  </tr>
  <tr>
    <td>
      <code>1-day</code>
    </td>
    <td>
      <code>renders/1-day</code>
    </td>
   
  </tr>
  
  <tr>
    <td>
      <code>3-days</code>
    </td>
    <td>
      <code>renders/3-days</code>
    </td>
   
  </tr>
  <tr>
    <td>
      <code>7-days</code>
    </td>
    <td>
      <code>renders/7-days</code>
    </td>
   
  </tr>
  <tr>
    <td>
      <code>30-days</code>
    </td>
    <td>
      <code>renders/30-days</code>
    </td>
   
  </tr>

</table>

## 参见



- [AWS对象到期](https://docs.aws.amazon.com/AmazonS3/latest/userguide/lifecycle-expire-general-considerations.html)
- [`deploySite()`](/docs/lambda/deploysite)
- [`renderMediaOnLambda()`](/docs/lambda/rendermediaonlambda)
